<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tensorflow.js linear regression</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>
</head>
<body>
    <script>

    async function plot(pointsArray, featureName){
        tfvis.render.scatterplot(
            {name: `${featureName} vs House Price`},
            {values: [pointsArray], series: ["original"]},
            {
                xLabel: featureName,
                YLabel: "Price",
            }
        );
    }
    //min-max normalization function
     function normalize(tensor) {
         const min = tensor.min();
         const max = tensor.max();
         const normalizedTensor = tensor.sub(min).div(max.sub(min));
         return {
             tensor: normalizedTensor,
             min,
             max,
            };
     }

     //denormalize (more understandable output)
     function denormalize(tensor, min, max){
         const denormalizedTensor = tensor.mul(max.sub(min)).add(min);
         return denormalizedTensor;
     }

     function createModel() {
        const model = tf.sequential();
        model.add(tf.layers.dense({
            units: 1,
            useBias: true,
            activation: 'linear',
            inputDim: 1,
        }))

        return model;
     }

     const optimizer = tf.train.sgd(0.1)
     model.compile({
         loss: 'meanSquaredError',
         optimizer,
     })


    async function run() {
        //Import from CSV
        const houseSalesDataset = tf.data.csv("http://192.168.1.181:8080/kc_house_data.csv")

        // Extract X and Y values to plot.
        const pointsDataset = houseSalesDataset.map(record =>({
            x: record.sqft_living,
            y: record.price,
        }));
        const points = await pointsDataset.toArray();
        if(points.length % 2 !== 0){//If odd # of elements
            points.pop();   // remove one element making it even
        }
        tf.util.shuffle(points);
        plot(points, "Square feet")

        //Extract Features
        const featureValues = points.map(p => p.x);
        const featureTensor = tf.tensor2d(featureValues, [featureValues.length, 1]);

        //Extract Labels
        const labelValues = points.map(p => p.y);
        const labelTensor = tf.tensor2d(labelValues, [labelValues.length, 1]);

        //Normalize features and labels
        const normalizedFeature = normalize(featureTensor);
        const normalizedLabel = normalize(featureTensor);        

        //split into two. One for training, one for testing.
        const [trainingFeatureTensor, testingFeatureTensor] = tf.split(normalizedFeature.tensor, 2);
        const [trainingLabelTensor, testingLabelTensor] = tf.split(normalizedLabel.tensor, 2);
        
        //inspecting the model
        const model = createModel();
        tfvis.show.modelSummary({ name: "Model Summary" }, model);
        const layer = model.getLayer(undefined, 0);
        tfvis.show.layer({ name: "Layer 1"}, layer);
    }
    run()
    </script>
</body>
</html>